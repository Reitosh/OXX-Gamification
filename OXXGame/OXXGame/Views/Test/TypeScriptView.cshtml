@model TestModel
@{
    ViewData["Title"] = "TypeScript";
    string output = Convert.ToString(ViewData["Output"]);
}

<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- CSS -->
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="~/css/mobile.css" />
    <link href="~/codemirror/lib/codemirror.css" rel="stylesheet" />
    <link href="~/codemirror/theme/base16-dark.css" rel="stylesheet" />
    <link href="~/codemirror/addon/scroll/simplescrollbars.css" rel="stylesheet" />

    <style>
        .CodeMirror {
            width: 100%;
            height: 500px;
            border: 1px solid black;
        }

        iframe {
            width: 0;
            height: 0;
            border: 0;
            border: none;
        }

        #TScontainer {
            padding-top: 5%;
            
        }

        .inline-div {
            display: inline-block;
            width: 49%;
        }
    </style>

</head>
<body onload="showTypeScript()">
    @using (Html.BeginForm("SubmitCode", "Test", FormMethod.Post))
    {
        <label class="test-text">Kategori: @Model.task.category </label><br />
        <label class="test-text">Vanskelighetsgrad: @Model.task.difficulty / 2</label><br />
        <label class="test-text">Oppgave: @Model.task.test</label><br />

     <div id="TScontainer">
        <div class="inline-div">
            <textarea asp-for="code" class="inline-txtarea" id="TypeScriptEditor">@Model.code</textarea>
        </div>
        <div class="inline-div">
            <textarea id="JavaScript" class="inline-txtarea"></textarea>
        </div>
      </div>

            <input type="submit" name="submitBtn" value="RunCode" />
        
        <textarea id="error"></textarea>
        <iframe id="TSiframe"></iframe>

        @Html.HiddenFor(model => model.singleTestResult.userId)
        @Html.HiddenFor(model => model.singleTestResult.testId)
        @Html.HiddenFor(model => model.task.testId)
        @Html.HiddenFor(model => model.task.category)
        @Html.HiddenFor(model => model.task.difficulty)
        @Html.HiddenFor(model => model.task.test)
        @Html.HiddenFor(model => model.singleTestResult.tries)
        @Html.HiddenFor(model => model.singleTestResult.passed)
        @Html.HiddenFor(model => model.startTime)
        @Html.HiddenFor(model => model.endTime)

        <input type="submit" name="submitBtn" value="NextTask" />
    }

    <!-- Scripts -->
    <script src="~/codemirror/lib/codemirror.js"></script>
    <script src="~/codemirror/mode/xml/xml.js"></script>
    <script src="~/codemirror/mode/css/css.js"></script>
    <script src="~/codemirror/mode/javascript/javascript.js"></script>
    <script src="~/codemirror/mode/css/css.js"></script>
    <script src="~/codemirror/mode/htmlmixed/htmlmixed.js"></script>
    <script src="~/codemirror/addon/edit/closebrackets.js"></script>
    <script src="~/codemirror/addon/scroll/simplescrollbars.js"></script>
    <script src="~/codemirror/addon/edit/matchtags.js"></script>
    <script src="~/codemirror/addon/edit/closetag.js"></script>
    <script src="~/codemirror/addon/display/placeholder.js"></script>

    <script>
        var TypeScriptEditor = CodeMirror.fromTextArea(
                document.getElementById('TypeScriptEditor'), {
                mode: "application/typescript",
                theme: "base16-dark",
                lineNumbers: true,
                indentUnit: 4,
                indentWithTabs: true,
                autoCloseTags: true,
                autoCloseBrackets: true,
                scrollbarStyle: "overlay",
                placeholder: "TypeScript"
        });

        var JavaScriptComp = CodeMirror.fromTextArea(
                document.getElementById('JavaScript'), {
                mode: "text/javascript",
                theme: "base16-dark",
                lineNumbers: true,
                indentUnit: 4,
                indentWithTabs: true,
                autoCloseTags: true,
                autoCloseBrackets: true,
                scrollbarStyle: "overlay",
                readOnly: "nocursor",
                placeholder: "Kompilert TypeScript"
            });

        var errorOutput = CodeMirror.fromTextArea(
                document.getElementById('error'), {
                mode: "application/typescript",
                theme: "base16-dark",
                readOnly: "nocursor",
                scrollbarStyle: "overlay",
                placeholder: "errors",
        });
        errorOutput.setSize("521", "150");

        function decodeChars(TypeScript) {
            var txt = document.createElement("textarea");
            txt.innerHTML = TypeScript;
            return txt.value;
        }

        function showTypeScript() {
            var decoded = decodeChars("@output");

            if (decoded.includes('error TS')) {
                errorOutput.getDoc().setValue(decoded);
            } else {
                var srcTypeScript = "<script>" + decoded + "<" + "/" + "script>";
                document.getElementById('TSiframe').srcdoc = srcTypeScript;
                JavaScriptComp.getDoc().setValue(decoded);
            }
        }
    </script>
</body>
</html>